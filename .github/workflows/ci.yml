name: GitHub CI

on: workflow_dispatch

jobs:
  generate-jobs:
    name: Generate  Jobs
    runs-on: ubuntu-latest
    outputs:
      strategy: ${{ steps.generate-jobs.outputs.strategy }}
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-node@v1
        with:
          node-version: 14
      - uses: php-actions/composer@v5
        with:
          only_args: --version
      - name: Add Composer Credentials
        run: echo '${{ secrets.COMPOSER_AUTH_JSON }}' > ${{ github.workspace }}/auth.json
      - name: Add Magento Composer Repository
        run: composer config -g repo.packagist false && composer config -g repositories.repo.magento.com composer https://repo.magento.com
      - id: install-dependencies
        name: Install NPM Dependencies
        run: npm install
        working-directory: ./lib
      - id: generate-jobs
        name: Generate Jobs
        run: echo "::set-output name=strategy::{\"matrix\":{\"include\":$(npm run --silent versions)}}"
        working-directory: ./lib

  build:
    needs: generate-jobs
    strategy: ${{ fromJson(needs.generate-jobs.outputs.strategy) }}
    name: "${{ matrix.version }}-php-${{ matrix.php.version }}-${{ matrix.php.variant }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - id: build
        name: Build
        run: docker build --build-arg PHP=${{ matrix.php.version }} --build-arg VARIANT=${{ matrix.php.variant }} --tag serializator/magento:${{ matrix.version }}-php-${{ matrix.php.version }}-${{ matrix.php.variant }} - < Dockerfile
      - id: images
        name: Images
        run: docker image ls